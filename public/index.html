<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Shadow Facets of Concurrency</title>

		<meta name="description" content="Reveal.js version of Shadow Facets of Concurrency prsentation">
		<meta name="author" content="Eugene Kalenkovich">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/serif.css" id="theme">
    <link rel="stylesheet" href="css/theme/concur.css">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="reveal/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

<!-- ----------------------------------------- --><section>

<h2>Rails: Shadow Facets of Concurrency</h2>

<small>
<p align="right">
  Eugene Kalenkovich
</p>
<p align="right">
  <a href="http://twitter.com/UncleGene">@UncleGene</a>
</p>
</small>

</section><!-- ----------------------------------------- --><section>

con·cur·ren·cy
<pre class="fragment">
  Definition of CONCURRENCE
  1 a : the simultaneous occurrence of events or circumstances
    b : the meeting of concurrent lines in a point
  2 a : agreement or union in action : cooperation
    b (1) : agreement in opinion or design (2) : consent
  3 : a coincidence of equal powers in law
</pre>
<q class="fragment" cite="http://en.wikipedia.org/wiki/Concurrency_(computer_science)">
  In computer science, concurrency is a property of systems in which several computations are executing simultaneously, and potentially interacting with each other
</q>
<pre class="fragment">
  Synonyms
  <b>coexistence, coincidence, concurrence</b>
  Antonyms
  <b>conflict, disagreement, dissensus</b>
</pre>

</section><!-- ----------------------------------------- --><section>

<h3>
  You may not worry about concurrency if:
</h3>
<ul>
  <li class="fragment">You use Rails</li>
  <li class="fragment">Your application is single-threaded</li>
  <li class="fragment">You have a very low traffic</li>
</ul>

</section><!-- ----------------------------------------- --><section>

<img src="images/SeattleMonorailAccident.jpg">
<aside class="notes" data-markdown>
CC-BY-SA-2.5 Garrett Fitzgerald
http://commons.wikimedia.org/wiki/File:SeattleMonorailAccident.jpg
</aside>

</section><!-- ----------------------------------------- --><section>

<h2>About me:</h2>

</section><!-- ----------------------------------------- --><section>

My first Rails site:
<img src="images/AmazonKindle.png">

</section><!-- ----------------------------------------- --><section>

My second one:
<img src="images/AmazonStudios.png">

</section><!-- ----------------------------------------- --><section>

<font color="red">&ldquo;</font>My<font color="red">&rdquo; - please pay attention to color ;-)</font>

</section><!-- ----------------------------------------- --><section>

<h2>Concurrency WTH</h2>
<small>(Why Things Happen)</small>

</section><!-- ----------------------------------------- --><section>

<h3>Development Environment</h3>
<img class="small" src="images/box_one_rails_one_db.png">

</section><!-- ----------------------------------------- --><section>

<h3>Production Environment</h3>
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_one_db.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">

</section><!-- ----------------------------------------- --><section>

<h3>Sources of Concurrency Problems</h3>
<ul>
  <li class="fragment">Shared resources
  <li class="fragment">Non-deterministic request processing
  <ul>
    <li class="fragment">Who
    <li class="fragment">When
  </ul>
</ul>

</section><!-- ----------------------------------------- --><section>

<h2>Part 1</h2>
<h3>Rails and Concurrency</h3>

</section><!-- ----------------------------------------- --><section>

<h3>Concurrent Testing</h3>
<pre class="fragment"><code data-trim>def concurrently processes = 10
    processes.times do
      fork do
        yield
      end
    end
    assert Process.waitall.map(&:last).all? &:success?
end
</code></pre>

</section><!-- ----------------------------------------- --><section>

<h3>Concurrent Testing</h3>
<pre><code>def concurrently processes = 10
  ActiveRecord::Base.remove_connection
  processes.times do
    fork do
      begin
        ActiveRecord::Base.establish_connection
        yield
      rescue => e
        puts "#{e.class.name}: #{e}" && exit 1
      ensure
        ActiveRecord::Base.remove_connection
      end
    end
  end
  ActiveRecord::Base.establish_connection
  assert Process.waitall.map(&:last).all? &:success?
end  
</code></pre>

<pre class="fragment subst"><code>def concurrently processes = 10
  <em>ActiveRecord::Base.remove_connection</em>
  processes.times do
    fork do
      begin
        <em>ActiveRecord::Base.establish_connection</em>
        yield
      rescue => e
        puts "#{e.class.name}: #{e}" && exit 1
      ensure
        <em>ActiveRecord::Base.remove_connection</em>
      end
    end
  end
  <em>ActiveRecord::Base.establish_connection</em>
  assert Process.waitall.map(&:last).all? &:success?
end
</code></pre>

<pre class="fragment subst"><code>def concurrently processes = 10
  ActiveRecord::Base.remove_connection
  processes.times do
    fork do
      begin
        ActiveRecord::Base.establish_connection
        yield
      <em>rescue => e</em>
        <em>puts "#{e.class.name}: #{e}" && exit 1</em>
      ensure
        ActiveRecord::Base.remove_connection
      end
    end
  end
  ActiveRecord::Base.establish_connection
  assert Process.waitall.map(&:last).all? &:success?
end
</code></pre>

</section><!-- ----------------------------------------- --><section>

<h2>find_or_create_by</h2>
<pre class="fragment"><code>class Number < ActiveRecord::Base
  # t.integer :value
end   
</code></pre>

<pre class="fragment"><code>describe Number do
  it 'should have unique values' do
    concurrently do
      10.times do
        Number.find_or_create_by_value Number.count
    end
    unique = Number.select('distinct value').count
    Number.count.must_equal unique
  end
end
</code></pre>

<pre class="fragment"><code> 1) Failure:
test_0001_should_have_unique_values(Number) :
Expected: 49
  Actual: 99
</code></pre>

</section><!-- ----------------------------------------- --><section>

<img src="images/GuateQuake1976BentRailsA.jpg">
<aside class="notes">
Public Domain
http://commons.wikimedia.org/wiki/File:GuateQuake1976BentRailsA.jpg
</aside>

</section><!-- ----------------------------------------- --><section>

<h2>find_or_create_by WTH</h2>

<pre class="fragment small"><code class="sql"> > Number.find_or_create_by_value(3)
  Number Load (16.2ms)  SELECT "numbers".* FROM "numbers" WHERE "numbers"."value" = 3 LIMIT 1
   (0.2ms)  BEGIN
  SQL (9.0ms)  INSERT INTO "numbers" ("value") VALUES ($1) RETURNING "id"  [["value", 3]]
   (0.4ms)  COMMIT
</code></pre>

<pre class="fragment small"><code class="sql"> > Number.where(:value => 5).first_or_create{ |r| r.value=5 }
  Number Load (0.4ms)  SELECT "numbers".* FROM "numbers" WHERE "numbers"."value" = 3 LIMIT 1
   (0.2ms)  BEGIN
  SQL (0.3ms)  INSERT INTO "numbers" ("value") VALUES ($1) RETURNING "id"  [["value", 3]]
   (0.5ms)  COMMIT
</code></pre>

<ul>
  <li class="fragment">Process 1: Does record exist? No.
  <li class="fragment">Process 2: Does record exist? No.
  <li class="fragment">Process 1: I am happy, insert a new one!
  <li class="fragment">Process 2: I am happy too, insert a new one!
</ul>

</section><!-- ----------------------------------------- --><section>

<img src="images/Train_wreck_at_Montparnasse_1895.jpg">
<aside class="notes">
PD
http://en.wikipedia.org/wiki/File:Train_wreck_at_Montparnasse_1895.jpg
</aside>

</section><!-- ----------------------------------------- --><section>

<h2>validates :uniquiness</h2>

<pre class="fragment"><code class="ruby">class ValidatedNumber < ActiveRecord::Base
  validates :value, :uniqueness => true
end
</code></pre>

<pre class="fragment small"><code class="ruby">describe ValidatedNumber do
  it 'should have unique values' do
    concurrently do
      10.times do
        ValidatedNumber.create{ |r| r.value = ValidatedNumber.count }
      end
    end
    unique = ValidatedNumber.select("distinct value").count
    ValidatedNumber.count.must_equal unique
  end
end
</code></pre>

<pre class="fragment"><code> 1) Failure:
test_0001_should_have_unique_values(ValidatedNumber):
Expected: 37
  Actual: 96
</code></pre>

<pre class="fragment subst small"><code class="sql"> > ValidatedNumber.create(:value=>1)
   (0.1ms)  BEGIN
  ValidatedNumber Exists (25.2ms)  SELECT 1 AS one FROM "validated_numbers" WHERE "validated_numbers"."value" = 1 LIMIT 1
  SQL (14.7ms)  INSERT INTO "validated_numbers" ("value") VALUES ($1) RETURNING "id"  [["value", 1]]
   (0.7ms)  COMMIT
</code></pre>

</section><!-- ----------------------------------------- --><section>

<img src="images/5786322835_e6428d9059_b.jpg">
<aside class="notes">
Courtesy of the Boston Public Library, Leslie Jones Collection
http://www.flickr.com/photos/boston_public_library/5786322835/
</aside>

</section><!-- ----------------------------------------- --><section>

<h2>WTF uniquiness</h2>
<small>(Way[s] To Fix)</small>

<pre class="fragment"><code class="ruby">class CreateConstrainedNumbers < ActiveRecord::Migration
  def change
    create_table :constrained_numbers do |t|
      t.integer :value
    end
    add_index :constrained_numbers, :value, :unique => true
  end
end
</code></pre>

<pre class="fragment small"><code class="unknown"># Running tests:

ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
</code></pre>

</section><!-- ----------------------------------------- --><section>

<img src="images/2488898004_feb5bf9787_b.jpg">
<aside class="notes">
CC BY-NC-ND 2.0 ATOMIC Hot Links
http://www.flickr.com/photos/7552532@N07/2488898004/
</aside>

</section><!-- ----------------------------------------- --><section>

<h2>WTF uniquiness #2</h2>

<pre class="fragment"><code class="ruby">class SafeNumber < ActiveRecord::Base
  def self.awesome_creation(val)
    where(value: val).first_or_create{ |r| r.value = val }
  rescue ActiveRecord::RecordNotUnique
    retry
  end
end
</code></pre>

<pre class="fragment small"><code class="unknown"># Running tests:

.

Finished tests in 8.337332s, 0.1199 tests/s, 0.2399 assertions/s.

1 tests, 2 assertions, 0 failures, 0 errors, 0 skips
</code></pre>

<pre class="fragment small"><code class="sql">ActiveRecord::StatementInvalid: Mysql2::Error: Deadlock found when trying to get lock; try restarting transaction: INSERT INTO `safe_numbers` (`value`) VALUES (132)
ActiveRecord::StatementInvalid: Mysql2::Error: Deadlock found when trying to get lock; try restarting transaction: INSERT INTO `safe_numbers` (`value`) VALUES (132)
F
</code></pre>


</section><!-- ----------------------------------------- -->
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,
				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: 'default', //Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'lib/js/fullscreen-img.js' }

					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});
      Reveal.addEventListener( 'fragmentshown', function( event ) {
        if (event.fragment.className.match(/(?:^|\s)subst(?!\S)/)) {
          event.fragment.previousElementSibling.className += " hidden";
        } 
      });
      Reveal.addEventListener( 'fragmenthidden', function( event ) {
        if (event.fragment.className.match(/(?:^|\s)subst(?!\S)/)) {
          event.fragment.previousElementSibling.className = 
            event.fragment.previousElementSibling.className.replace( /(?:^|\s)hidden(?!\S)/g , '' );
        }
      });
		</script>

	</body>
</html>
