<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Shadow Facets of Concurrency</title>

		<meta name="description" content="Reveal.js version of Shadow Facets of Concurrency prsentation">
		<meta name="author" content="Eugene Kalenkovich">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/serif.css" id="theme">
    <link rel="stylesheet" href="concur.css">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="github.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="reveal/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
<!-- TODO: hash syntax here and in the code -->
<!-- title --><section>

<h2>Rails: Shadow Facets of Concurrency</h2>

<small>
<p align="right">
  Eugene Kalenkovich
</p>
<p align="right">
  <a href="http://twitter.com/UncleGene">@UncleGene</a>
</p>
</small>

</section>
<!--   concurrency definitions --><section>

con·cur·ren·cy
<pre class="fragment">
  Definition of CONCURRENCE
  1 a : the simultaneous occurrence of events or circumstances
    b : the meeting of concurrent lines in a point
  2 a : agreement or union in action : cooperation
    b (1) : agreement in opinion or design (2) : consent
  3 : a coincidence of equal powers in law
</pre>
<q class="fragment" cite="http://en.wikipedia.org/wiki/Concurrency_(computer_science)">
  In computer science, concurrency is a property of systems in which several computations are executing simultaneously, and potentially interacting with each other
</q>
<pre class="fragment">
  Synonyms
  <b>coexistence, coincidence, concurrence</b>
  Antonyms
  <b>conflict, disagreement, dissensus</b>
</pre>

</section>
<!--   vocabulary --><section>

<h2>Vocabulary</h2>

<ul>
  <li class="fragment"><b>Concurrency:</b>
    <span class="fragment">Concurrency Problems [conflict, disagreement, dissensus]</span></li>
  <li class="fragment"><b>WTH:</b>
    <span class="fragment">Why Things Happen</span></li>
  <li class="fragment"><b>WTF</b>
    <ol>
      <li class="fragment">Way[s] To Fix</li>
      <li class="fragment">Why This Framework [did not do this for me]?</small></li>
    </ol>
  </li>
</ul>

</section>
<!--   quiz --><section>

<h3>
  You may not worry about concurrency if:
</h3>
<ul>
  <li class="fragment">You use Rails</li>
  <li class="fragment">Your application is single-threaded</li>
  <li class="fragment">You have a very low traffic</li>
</ul>

</section>
<!--     img: monorail --><section>

<img src="images/SeattleMonorailAccident.jpg">
<aside class="notes" data-markdown>
CC-BY-SA-2.5 Garrett Fitzgerald
http://commons.wikimedia.org/wiki/File:SeattleMonorailAccident.jpg
</aside>

</section>
<!--   About me <section>

<h2>About me:</h2>

</section>
<!--     AmazonKindle <section>

My first Rails site:
<img src="images/AmazonKindle.jpg">

</section>
<!--     AmazonStudios <section>

My second one:
<img src="images/AmazonStudios.jpg">

</section>
<!--       disclaimer <section>

<font color="red">&ldquo;</font>My<font color="red">&rdquo; - please pay attention to color ;-)</font></section> -->
<!--   Concurrency WTH --><section>

<h2>Concurrency WTH</h2>

</section>
<!--     development --><section>

<h3>Development Environment</h3>
<img class="small" src="images/box_one_rails_one_db.png">

</section>
<!--     production --><section>

<h3>Production Environment</h3>
<div>
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_one_db.png">
</div>
<div class="fragment subst" data-fragment-index="2">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_one_db.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
</div>

<ul>
  <li class="fragment" data-fragment-index="1">Shared resources
  <li class="fragment" data-fragment-index="3">Non-deterministic request processing
  <ul>
    <li class="fragment" data-fragment-index="4">Who
    <li class="fragment" data-fragment-index="5">When
  </ul>
</ul>

</section>
<!-- Part 1. Rails and Concurrency --><section>

<h2>Part 1</h2>
<h3>Rails and Concurrency</h3>

</section>
<!--     concurrent testing - abridged --><section>

<h3>Concurrent Testing</h3>
<div class="fragment">
    database.yml:
    <pre><code>test:
  adapter: postgresql  # mysql2
  database: concur_test</code></pre>
</div>
<div class="fragment">
  test_helper.rb (spec_helper.rb):
<pre><code class="ruby">def concurrently processes = 10
  processes.times do
    fork do
      yield
    end
  end
  assert Process.waitall.map(&:last).all? &:success?
end
</code></pre>
<pre class="fragment subst"><code class="ruby" data-noescape>def concurrently processes = 10
  processes.times do
    <em>fork do</em>
      <em>yield</em>
    <em>end</em>
  end
  assert Process.waitall.map(&:last).all? &:success?
end
</code></pre>
<pre class="fragment subst"><code class="ruby" data-noescape>def concurrently processes = 10
  processes.times do
    fork do
      yield
    end
  end
  <em>assert Process.waitall.map(&:last).all? &:success?</em>
end
</code></pre>
</div>
</section>
<!--     concurrent testing - complete --><section>

<h3>Concurrent Testing</h3>
<pre><code class="rub">def concurrently processes = 10
  ActiveRecord::Base.remove_connection
  processes.times do
    fork do
      begin
        ActiveRecord::Base.establish_connection
        yield
      rescue => e
        puts "#{e.class.name}: #{e}" && exit 1
      ensure
        ActiveRecord::Base.remove_connection
      end
    end
  end
  ActiveRecord::Base.establish_connection
  assert Process.waitall.map(&:last).all? &:success?
end  
</code></pre>

<pre class="fragment subst"><code class="ruby" data-noescape>def concurrently processes = 10
  <em>ActiveRecord::Base.remove_connection</em>
  processes.times do
    fork do
      begin
        <em>ActiveRecord::Base.establish_connection</em>
        yield
      rescue => e
        puts "#{e.class.name}: #{e}" && exit 1
      ensure
        <em>ActiveRecord::Base.remove_connection</em>
      end
    end
  end
  <em>ActiveRecord::Base.establish_connection</em>
  assert Process.waitall.map(&:last).all? &:success?
end
</code></pre>

<pre class="fragment subst"><code class="ruby" data-noescape>def concurrently processes = 10
  ActiveRecord::Base.remove_connection
  processes.times do
    fork do
      begin
        ActiveRecord::Base.establish_connection
        yield
      <em>rescue => e</em>
        <em>puts "#{e.class.name}: #{e}" && exit 1</em>
      ensure
        ActiveRecord::Base.remove_connection
      end
    end
  end
  ActiveRecord::Base.establish_connection
  assert Process.waitall.map(&:last).all? &:success?
end
</code></pre>

</section>
<!--   WTH1: Unique --><section>

<h2>WTH 1: One and Only</h2>
<img src="images/unique_by_sorah42-d33i1bm.jpg">
<aside class="notes">
cc by-sa 3.0 SoRah42
http://sorah42.deviantart.com/art/Unique-187278898
</aside>


</section>
<!--     naive find_or_create --><section>

<h2>find_or_create_by</h2>
<pre class="fragment"><code class="ruby">class Number < ActiveRecord::Base
  # t.integer :value
end   
</code></pre>

<pre class="fragment"><code class="ruby" data-noescape>describe Number do
  it 'should have unique values' do
    concurrently do
      10.times do
        Number.find_or_create_by_value Number.count
      end
    end
    Number.count.must_equal Number.select('distinct value').count
  end
end
</code></pre>
<pre class="fragment subst"><code class="ruby" data-noescape>describe Number do
  it 'should have unique values' do
    concurrently do
      10.times do
        <em>Number.find_or_create_by_value Number.count</em>
      end
    end
    Number.count.must_equal Number.select('distinct value').count
  end
end
</code></pre>
<pre class="fragment subst"><code class="ruby" data-noescape>describe Number do
  it 'should have unique values' do
    concurrently do
      10.times do
        Number.find_or_create_by_value Number.count
      end
    end
    <em>Number.count.must_equal Number.select('distinct value').count</em>
  end
end
</code></pre>


<pre class="fragment"><code class="no-highlight"> 1) Failure:
test_0001_should_have_unique_values(Number) :
Expected: 49
  Actual: 99
</code></pre>

</section>
<!--       img: quake bent rails --><section>

<img src="images/GuateQuake1976BentRailsA.jpg">
<aside class="notes">
Public Domain
http://commons.wikimedia.org/wiki/File:GuateQuake1976BentRailsA.jpg
</aside>

</section>
<!--  TODO: detailed transitions below -->
<!--     find_or_create_by WTH --><section>

<h2>find_or_create_by WTH</h2>

<pre class="fragment"><code class="sql"> > Number.find_or_create_by_value(3)
  Number Load (16.2ms)  SELECT "numbers".* FROM "numbers" WHERE "numbers"."value" = 3 LIMIT 1
   (0.2ms)  BEGIN
  SQL (9.0ms)  INSERT INTO "numbers" ("value") VALUES ($1) RETURNING "id"  [["value", 3]]
   (0.4ms)  COMMIT
</code></pre>

<pre class="fragment"><code class="sql"> > Number.where(:value => 3).first_or_create{ |r| r.value = 3 }
  Number Load (0.4ms)  SELECT "numbers".* FROM "numbers" WHERE "numbers"."value" = 3 LIMIT 1
   (0.2ms)  BEGIN
  SQL (0.3ms)  INSERT INTO "numbers" ("value") VALUES ($1) RETURNING "id"  [["value", 3]]
   (0.5ms)  COMMIT
</code></pre>

<ul>
  <li class="fragment">Process 1: Does record exist? No.
  <li class="fragment">Process 2: Does record exist? No.
  <li class="fragment">Process 1: I am happy, insert a new one!
  <li class="fragment">Process 2: I am happy too, insert a new one!
</ul>

</section>
<!--       img: train wreck --><section>

<img src="images/Train_wreck_at_Montparnasse_1895.jpg">
<aside class="notes">
PD
http://en.wikipedia.org/wiki/File:Train_wreck_at_Montparnasse_1895.jpg
</aside>

</section>
<!--     validates :uniquiness --><section>

<h2>validates :uniquiness</h2>

<pre class="fragment"><code class="ruby">class ValidatedNumber < ActiveRecord::Base
  validates :value, :uniqueness => true
end
</code></pre>

<pre class="fragment"><code class="ruby">describe ValidatedNumber do
  it 'should have unique values' do
    concurrently do
      10.times do
        ValidatedNumber.create{ |r| r.value = ValidatedNumber.count }
      end
    end
    unique = ValidatedNumber.select("distinct value").count
    ValidatedNumber.count.must_equal unique
  end
end
</code></pre>

<pre class="fragment"><code class="no-highlight">
1) Failure:
test_0001_should_have_unique_values(ValidatedNumber):
Expected: 37
  Actual: 96

</code></pre>

<pre class="fragment subst"><code class="sql"> > ValidatedNumber.create(:value=>1)
   (0.1ms)  BEGIN
  ValidatedNumber Exists (25.2ms)  SELECT 1 AS one FROM "validated_numbers" WHERE "validated_numbers"."value" = 1 LIMIT 1
  SQL (14.7ms)  INSERT INTO "validated_numbers" ("value") VALUES ($1) RETURNING "id"  [["value", 1]]
   (0.7ms)  COMMIT
</code></pre>

</section>
<!--       img: overturned car --><section>

<img src="images/5786322835_e6428d9059_b.jpg">
<aside class="notes">
Courtesy of the Boston Public Library, Leslie Jones Collection
http://www.flickr.com/photos/boston_public_library/5786322835/
</aside>

</section>
<!--     add db constraint --><section>

<h2>WTF uniquiness</h2>

<pre class="fragment"><code class="ruby">class CreateConstrainedNumbers < ActiveRecord::Migration
  def change
    create_table :constrained_numbers do |t|
      t.integer :value
    end
    add_index :constrained_numbers, :value, :unique => true
  end
end
</code></pre>

<pre class="fragment"><code class="no-highlight"># Running tests:

ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
ActiveRecord::RecordNotUnique: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
[...]
</code></pre>

<pre class="fragment subst"><code class="no-highlight" data-noescape># Running tests:

<em>ActiveRecord::RecordNotUnique</em>: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
<em>ActiveRecord::RecordNotUnique</em>: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
<em>ActiveRecord::RecordNotUnique</em>: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
<em>ActiveRecord::RecordNotUnique</em>: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
<em>ActiveRecord::RecordNotUnique</em>: PG::Error: ERROR:  duplicate key value violates unique constraint "index_constrained_numbers_on_value"
DETAIL:  Key (value)=(0) already exists.
: INSERT INTO "constrained_numbers" ("value") VALUES ($1) RETURNING "id"
[...]
</code></pre>

</section>
<!--       img: train over wall --><section>

<img src="images/2488898004_feb5bf9787_b.jpg">
<aside class="notes">
CC BY-NC-ND 2.0 ATOMIC Hot Links
http://www.flickr.com/photos/7552532@N07/2488898004/
</aside>

</section>
<!--     catch RecordNotFound --><section>

<h2>WTF uniquiness #2</h2>

<pre class="fragment"><code class="ruby">class SafeNumber < ActiveRecord::Base
  def self.awesome_creation(val)
    where(value: val).first_or_create{ |r| r.value = val }
  rescue ActiveRecord::RecordNotUnique
    retry
  end
end
</code></pre>

<pre class="fragment"><code class="no-highlight"># Running tests:

.

Finished tests in 8.337332s, 0.1199 tests/s, 0.2399 assertions/s.

1 tests, 2 assertions, 0 failures, 0 errors, 0 skips
</code></pre>

<pre class="fragment"><code class="sql">ActiveRecord::StatementInvalid: Mysql2::Error: Deadlock found when trying to get lock; try restarting transaction: INSERT INTO `safe_numbers` (`value`) VALUES (132)
ActiveRecord::StatementInvalid: Mysql2::Error: Deadlock found when trying to get lock; try restarting transaction: INSERT INTO `safe_numbers` (`value`) VALUES (132)
F
</code></pre>

</section>
<!--       img: curved rails --><section>

<img src="images/4963981594_849491e7cc_o.jpg">
<aside class="notes">
CC BY-ND 2.0 Mike Campbell
http://www.flickr.com/photos/morphyoss/4963981594/
</aside>

</section>
<!--     MySQL uniquiness --><section>

<h2>WTF uniquiness - MySQL</h2>

<pre class="fragment"><code class="ruby">def self.extra_awesome_creation(val)
    where(value: val).
      first_or_create{ |r| r.value = val }
  rescue ActiveRecord::RecordNotUnique
    retry
  rescue ActiveRecord::StatementInvalid => e
    retry if e.message =~ /Deadlock/
    # Thank you, MySQL and Mysql2!
    raise
  end
</code></pre>

<pre class="fragment"><code class="no-highlight"># Running tests:

.

Finished tests in 3.234423s, 0.3092 tests/s, 0.6183 assertions/s.

1 tests, 2 assertions, 0 failures, 0 errors, 0 skips
</code></pre>

</section>
<!--       img: fast train --><section>

<img src="images/fast_train.jpg">
<aside class="notes">
CC-BY-NC-ND 3.0 Swansea
http://www.freefoto.com/download/23-22-1/Swansea-London-Paddington-High-Speed-Train--HST-
</aside>

</section>
<!--   WTH 2: Assoiations --><section>

<h2>WTH 2: I Can Has One or Many?</h2>

</section>
<!--     dog with had and legs --><section>

<h2>Associations</h2>

<pre class="fragment"><code class="ruby">class Dog < ActiveRecord::Base
  has_one :head
  has_many :legs
end
</code></pre>

<pre class="fragment"><code class="ruby">class Head < ActiveRecord::Base
  belongs_to :dog
end

class Leg < ActiveRecord::Base
  belongs_to :dog
end
</code></pre>

</section>
<!--     dog creation code --><section>

<h2>Let Make Some Dogs</h2>

<pre><code class="ruby">20.times{ Dog.create }

concurrently do
  begin
    headless = Dog.includes(:head).reject(&:head).first
    headless && headless.create_head

    legless = Dog.includes(:legs).select{|d| d.legs.empty?}.first
    legless && legless.legs = 4.times.map{ Leg.create }
  end while headless || legless
end
</code></pre>

</section>
<!--     many dogs with many heads --><section>

<h2>And See What We Get</h2>

<pre><code class="ruby">pretty_report(Dog.all).must_equal "20 dogs with 1 head and 4 legs"</code></pre>

<pre class="fragment"><code class="no-highlight">--- expected
+++ actual
@@ -1 +1 @@
-"20 dogs with 1 head and 4 legs"
+"3 dogs with 1 head and 8 legs, 2 dogs with 2 heads and 28 legs, 2 dogs with 1 head and 12 legs, 1 dog with 1 head and 4 legs, 1 dog with 4 heads and 24 legs, 1 dog with 4 heads and 32 legs, 1 dog with 3 heads and 16 legs, 1 dog with 2 heads and 32 legs, 1 dog with 1 head and 16 legs, 1 dog with 6 heads and 8 legs, 1 dog with 1 head and 20 legs, 1 dog with 2 heads and 16 legs, 1 dog with 4 heads and 36 legs, 1 dog with 5 heads and 24 legs, 1 dog with 8 heads and 20 legs, 1 dog with 2 heads and 40 legs"
</code></pre>

</section>
<!--       img: crash --><section>

<img src="images/crash.jpg">
<aside class="notes">
PD
http://commons.wikimedia.org/wiki/File:Loket_vid_j%C3%A4rnv%C3%A4gsolyckan_i_Get%C3%A5_1918.jpg
</aside>

</section>
<!--     WTH heads --><section>

<h2>WTH with Heads</h2>

<pre class="fragment"><code class="sql">> Dog.first.create_head
  Dog Load (0.3ms)  SELECT "dogs".* FROM "dogs" LIMIT 1
   (0.1ms)  BEGIN
  SQL (12.0ms)  INSERT INTO "heads" ("dog_id") VALUES ($1) RETURNING "id"  [["dog_id", 1]]
   (0.9ms)  COMMIT
  Head Load (0.2ms)  SELECT "heads".* FROM "heads" WHERE "heads"."dog_id" = 1 LIMIT 1
   (0.1ms)  BEGIN
   (0.2ms)  UPDATE "heads" SET "dog_id" = NULL WHERE "heads"."id" = 1
   (0.4ms)  COMMIT
</code></pre>

<pre class="fragment subst"><code class="sql" data-noescape>> Dog.first.create_head
  Dog Load (0.3ms)  SELECT "dogs".* FROM "dogs" LIMIT 1
   (0.1ms)  BEGIN
  SQL (12.0ms)  INSERT INTO "heads" ("dog_id") VALUES ($1) RETURNING "id"  [["dog_id", 1]]
   (0.9ms)  COMMIT
  Head Load (0.2ms)  <em>SELECT "heads".* FROM "heads" WHERE "heads"."dog_id" = 1 LIMIT 1</em>
   (0.1ms)  BEGIN
   (0.2ms)  UPDATE "heads" SET "dog_id" = NULL WHERE "heads"."id" = 1
   (0.4ms)  COMMIT
</code></pre>

</section>
<!--       img: many heads --><section>
<img src="images/three_heads.jpg">

</section>
<!--     WTH legs --><section>

<h2>WTH with Legs</h2>

<pre class="fragment"><code class="sql">>   Dog.first.legs = Leg.all.sample(4)
  Dog Load (0.3ms)  SELECT "dogs".* FROM "dogs" LIMIT 1
  Leg Load (0.2ms)  SELECT "legs".* FROM "legs"
  Leg Load (0.3ms)  SELECT "legs".* FROM "legs" WHERE "legs"."dog_id" = 1
   (0.1ms)  BEGIN
   (0.2ms)  UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 6
   (0.2ms)  UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 3
   (0.2ms)  UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 10
   (0.1ms)  UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 5
   (0.5ms)  COMMIT
</code></pre>

<pre class="fragment"><code class="sql" data-noescape>> Dog.first.legs = Leg.all.sample(4)
  Dog Load (0.4ms)  SELECT "dogs".* FROM "dogs" LIMIT 1
  Leg Load (0.3ms)  SELECT "legs".* FROM "legs"
  Leg Load (0.3ms)  SELECT "legs".* FROM "legs" WHERE "legs"."dog_id" = 1
   (0.1ms)  BEGIN
  SQL (0.3ms)  UPDATE "legs" SET "dog_id" = NULL WHERE "legs"."dog_id" = 1 AND "legs"."id" IN (10, 5)
   (0.2ms)  <em>UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 2</em>
   (0.2ms)  <em>UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 9</em>
   (0.6ms)  COMMIT
</code></pre>

<pre class="fragment subst"><code class="sql" data-noescape>> Dog.first.legs = Leg.all.sample(4)
  Dog Load (0.4ms)  SELECT "dogs".* FROM "dogs" LIMIT 1
  Leg Load (0.3ms)  SELECT "legs".* FROM "legs"
  Leg Load (0.3ms)  <em>SELECT "legs".* FROM "legs" WHERE "legs"."dog_id" = 1</em>
   (0.1ms)  BEGIN
  SQL (0.3ms)  UPDATE "legs" SET "dog_id" = NULL WHERE "legs"."dog_id" = 1 AND "legs"."id" IN (10, 5)
   (0.2ms)  UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 2
   (0.2ms)  UPDATE "legs" SET "dog_id" = 1 WHERE "legs"."id" = 9
   (0.6ms)  COMMIT
</code></pre>

</section>
<!--       img: many legs --><section>

<img src="images/many_legs.jpg">

</section>
<!--     WTF has_one --><section>

<h2>WTF has_one Association</h2>

<span class="fragment">See WTF uniquiness</span>

</section>
<!--     WTF Associations - lock! --><section>

<h2>WTF Associations</h2>

<pre class="fragment"><code class="ruby">headless = Dog.includes(:head).reject(&:head).first
headless && Dog.transaction do
  headless.lock!
  headless.create_head
end
legless = Dog.includes(:legs).select{|d| d.legs.empty?}.first
legless && Dog.transaction do
  legless.lock!
  legless.legs = 4.times.map{ Leg.create }
end
</code></pre>
<pre class="fragment subst"><code class="ruby" data-noescape>headless = Dog.includes(:head).reject(&:head).first
headless && <em>Dog.transaction do</em>
  <em>headless.lock!</em>
  headless.create_head
end
legless = Dog.includes(:legs).select{|d| d.legs.empty?}.first
legless && <em>Dog.transaction do</em>
  <em>legless.lock!</em>
  legless.legs = 4.times.map{ Leg.create }
end
</code></pre>

<pre class="fragment"><code class="no-highlight">1 tests, 2 assertions, 0 failures, 0 errors, 0 skips</code></pre>

<pre class="fragment"><code class="no-highlight">--- expected
+++ actual
@@ -1 +1 @@
-"50 dogs with 1 head and 4 legs"
+"30 dogs with 1 head and 4 legs, 11 dogs with 2 heads and 4 legs, 4 dogs with 3 heads and 4 legs, 4 dogs with 4 heads and 4 legs, 1 dog with 5 heads and 4 legs"
</code></pre>

</section>
<!--       img: car over water --><section>

<img src="images/car_over_water.jpg">
<aside class="notes">
Courtesy of the Boston Public Library, Leslie Jones Collection
http://www.flickr.com/photos/boston_public_library/5786875562/
</aside>

</section>
<!--     WTF Associations select for update --><section>

<h2>WTF Associations #2</h2>

<pre class="fragment"><code class="ruby">headless, legless = nil, nil
Dog.transaction do
  headless = Dog.lock.includes(:head).reject(&:head).first
  headless && headless.create_head
end
Dog.transaction do
  legless = Dog.lock.includes(:legs).select{|d| d.legs.empty?}.first
  legless && legless.legs = 4.times.map{ Leg.create }
end
</code></pre>

<pre class="fragment subst"><code class="ruby" data-noescape>headless, legless = nil, nil
Dog.transaction do
  headless = <em>Dog.lock.includes(:head).reject(&:head).first</em>
  headless && headless.create_head
end
Dog.transaction do
  legless = <em>Dog.lock.includes(:legs).select{|d| d.legs.empty?}.first</em>
  legless && legless.legs = 4.times.map{ Leg.create }
end
</code></pre>

</section>
<!--     WTF Associations - DIY --><section>

<h2>WTF Associations - DIY</h2>

<pre class="fragment"><code class="ruby">headless = Dog.includes(:head).reject(&:head).first
if headless
  headless.create_head
  Head.update_all( { :dog_id => nil },
    { :id => Head.where(:dog_id => headless.id).order(:id).pluck(:id)[0..-2] })
end
legless = Dog.includes(:legs).select{|d| d.legs.empty?}.first
if legless
  legless.legs = 4.times.map{ Leg.create }
  Leg.update_all( { :dog_id => nil },
    { :id => Leg.where(:dog_id => legless.id).order(:id).pluck(:id)[0..-5] })
end
</code></pre>
<pre class="fragment subst"><code class="ruby" data-noescape>headless = Dog.includes(:head).reject(&:head).first
if headless
  headless.create_head
  <em>Head.update_all( { :dog_id => nil },</em>
    <em>{ :id => Head.where(:dog_id => headless.id).order(:id).pluck(:id)[0..-2] })</em>
end
legless = Dog.includes(:legs).select{|d| d.legs.empty?}.first
if legless
  legless.legs = 4.times.map{ Leg.create }
  <em>Leg.update_all( { :dog_id => nil },</em>
    <em>{ :id => Leg.where(:dog_id => legless.id).order(:id).pluck(:id)[0..-5] })</em>
end
</code></pre>

</section>
<!--   WTH 3: Migrations --><section>

<h2>WTH 3: Emigration</h2>

</section>
<!--     DB migrations --><section>

<h2>DB Migrations</h2>
    <ul>
        <li class="fragment">Add table - OK</li>
        <li class="fragment">Add column - OK</li>
        <li class="fragment">Add/remove index - so-so</li>
        <li class="fragment">Remove column - oops</li>
    </ul>

</section>
<!--     remove_column errors --><section>

<h2>DB Migrations</h2>

<pre class="fragment"><code class="ruby">remove_column :extra_columns, :extra</code></pre>

<pre class="fragment"><code class="sql">> ExtraColumn.create
   (0.2ms)  BEGIN
  SQL (34.9ms)  INSERT INTO "extra_columns" ("extra", "value") VALUES ($1, $2) RETURNING "id"  [["extra", nil], ["value", nil]]
   (0.2ms)  ROLLBACK
ActiveRecord::StatementInvalid: PG::Error: ERROR:  column "extra" of relation "extra_columns" does not exist at character 30
: INSERT INTO "extra_columns" ("extra", "value") VALUES ($1, $2) RETURNING "id"
</code></pre>
<pre class="fragment"><code class="sql">> ExtraColumn.create
   (0.1ms)  BEGIN
  SQL (62.7ms)  INSERT INTO `extra_columns` (`extra`, `value`) VALUES (NULL, NULL)
Mysql2::Error: Unknown column 'extra' in 'field list': INSERT INTO `extra_columns` (`extra`, `value`) VALUES (NULL, NULL)
   (0.1ms)  ROLLBACK
ActiveRecord::StatementInvalid: Mysql2::Error: Unknown column 'extra' in 'field list': INSERT INTO `extra_columns` (`extra`, `value`) VALUES (NULL, NULL)
</code></pre>

</section>
<!--       img: train crash --><section>

<img src="images/rebels.jpg">
<aside class="notes">
PD A.J. Russell
http://commons.wikimedia.org/wiki/File:A.J._Russell_(American_-_Railroad_Accident_Caused_by_Rebels_-_Google_Art_Project.jpg
</aside>

</section>
<!--     WTH with remove_column --><section>

<h2>WTH with remove_column</h2>

<pre class="fragment"><code class="ruby">def columns
  @columns ||= connection.schema_cache.columns[table_name].map do |col|
    col = col.dup
    col.primary = (col.name == primary_key)
    col
  end
end
</code></pre>
<ul>
<li class="fragment">All operations are defined in terms of klass.columns (directly or indirectly)</li>
<li class="fragment">True for Rails 2.x, 3.0 <img class= "fragment smallTop" src="images/gap.jpg"> 3.2, 4.0</li>
</ul>

</section>
<!--     WTF remove_column --><section>

<h2>WTF remove_column</h2>

<ul>
<pre class="fragment"><code class="ruby">class ExtraColumn < ActiveRecord::Base
  def self.columns
    @my_columns ||= super.reject { |c|
      c.name == 'extra'
    }
  end
end
</code></pre>
<li class="fragment">Deploy</li>
<pre class="fragment"><code class="ruby">remove_column :extra_columns, :extra</code></pre></li>
<li class="fragment">Remove ExtraColumn.columns</li>
<li class="fragment">Deploy</li>
</ul>

</section>
<!--     Rails 3.1 WTF --><section>

<h2>Rails 3.1 "WTF" remove_column</h2>

<img src="images/3.1.jpg">

</section>
<!--       img: car_on_car  --><section>

<img src="images/car_on_car.jpg">
<aside class="notes">
Courtesy of the Boston Public Library, Leslie Jones Collection
http://www.flickr.com/photos/boston_public_library/5786895180/
</aside>

</section>
<!--   WTH 4: Assets --><section>

<h2>WTH 4: Assets</h2>

</section>
<!-- TODO: deploy via shutdown -->
<!--     rolling deploy assets WTH --><section>
        <h2>Deployment</h2>
<span>
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<span>
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<img class="fragment small subst" src="images/box_many_rails_g.png">
</span>
<span class="fragment subst">
<img class="small" src="images/box_many_rails_g.png">
<img class="small" src="images/box_many_rails_g.png">
</span>
</span>
<span class="fragment subst">
<img class="small" src="images/box_many_rails_g.png">
<img class="small" src="images/box_many_rails_g.png">
<img class="small" src="images/box_many_rails_g.png">
<img class="small" src="images/box_many_rails_g.png">
<img class="small" src="images/box_many_rails_g.png">
</span>

</section>
<!--     WTF with assets --><section>
<h2>WTF Assets</h2>
<pre class="fragment"><code class="ruby">config.action_controller.asset_host = "//your.super.asset.host"</code></pre></li>
<ul>
    <li class="fragment">For S3 you can use gem 'asset_sync'</li>
    <li class="fragment">... or roll out your own solution to upload precompiled assets before deployment</li>
    <li class="fragment">Do not delete old assets too early</li>
</ul>
<pre class="fragment"><code class="ruby">config.assets.digest = true</code></pre>
</section>
<!--       img: fast  --><section>

<img src="images/fast.jpg">
<aside class="notes">
CC-BY-SA 3.0 Bhanutpt
http://commons.wikimedia.org/wiki/File:Fast_Moving_Train_India.jpg
</aside>

</section>
<!--   WTH with Rails --><section>
<h2>WTH with Rails</h2>
<div class="fragment">
<blockquote cite="http://david.heinemeierhansson.com/2012/rails-is-omakase.html">
    Rails is omakase. A team of chefs picked out the ingredients, designed the APIs, and arranged the order
    of consumption on your behalf according to their idea of what would make for a tasty full-stack framework.
</blockquote>
<p class="author">DHH</p>
</div>
<small class="fragment">
    NOTICE: Consuming raw or undercooked meats, poultry, seafood, shellfish, or eggs may increase your risk
    of foodborne illness
</small>
</section>
<!-- Part 2. Beyond Rails --><section>

<h2>Part 2</h2>
<h3>Beyond Rails</h3>

</section>
<!--   Development and Deployment --><section>
<h2>Development and Deployment</h2>
<div class="fragment">
<blockquote cite="http://david.heinemeierhansson.com/2012/rails-is-omakase.html">
    Concurrency of development with deployment . . . has almost always proven counterproductive
</blockquote>
<p class="author">Harold Brown</p>
</div>

</section>
<!--     Call for volunteers --><section>
<h2>Development and Deployment</h2>
<img class="small" src="images/box_many_rails_g.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<img class="small" src="images/box_many_rails.png">
<p class="fragment">I Can Has Four Volunteers?</p>
</section>
<!--       img: railroad  --><section>

<img src="images/railroad.jpg">
<aside class="notes">
CC BY 2.0 Chris Updegrave
http://www.flickr.com/photos/cupdegrave/2253462031/
</aside>

</section>
<!--     WTF Development and Deployment --><section>
<h2>WTF Development and Deployment</h2>
<ul>
    <li class="fragment">
        Your website is an API server and a client at the same time (but client is behind!)
    </li>
    <li class="fragment">Treat changing features as a new API version</li>
    <ol>
        <li class="fragment">Teach old dog new tricks (but do not show them)</li>
        <li class="fragment">Teach new dog old tricks</li>
        <li class="fragment">Swap your dogs</li>
        <li class="fragment">Wait...</li>
        <li class="fragment">Now you can forget old tricks</li>
    </ol>
</ul>

</section>
<!--   to_do || !to_do == true - if can speak fast --><section>

</section>
<!-- quiz recap --><section>

<h3>
  You may not worry about concurrency if:
</h3>
<ul>
  <li class="fragment">You do not care</li>
  <li class="fragment">But if you do – worry, and you will (almost) always find your way</li>
</ul>

</section>
<!--   img: many ways  --><section>

<img src="images/many_ways.jpg">
<aside class="notes">
CC BY-NC-ND 2.0 SCFiasco
http://www.flickr.com/photos/scfiasco/4490322916/
</aside>

</section>
<!-- credits --><section>
    <h4>Credits</h4>
<ul class="tiny">
  <li>concurrency - Merriam-Webster.com. 2013. http://www.merriam-webster.com (5 Aug 2013)</li>
  <li>software concurrency - http://en.wikipedia.org/wiki/Concurrency_(computer_science)</li>
  <li>David Heinemeier Hansson - http://david.heinemeierhansson.com/2012/rails-is-omakase.html</li>
  <li>Harold Brown - http://www.foreignaffairs.com/articles/40540/harold-brown/is-sdi-technically-feasible</li>

<li>Images:</li>
<ul>
  <li>Garrett Fitzgerald - http://commons.wikimedia.org/wiki/File:SeattleMonorailAccident.jpg</li>
  <li>SoRah42 - http://sorah42.deviantart.com/art/Unique-187278898</li>
  <li>http://commons.wikimedia.org/wiki/File:GuateQuake1976BentRailsA.jpg</li>
  <li>http://en.wikipedia.org/wiki/File:Train_wreck_at_Montparnasse_1895.jpg</li>
  <li>Courtesy of the Boston Public Library, Leslie Jones Collection:
    <ul>
        <li>http://www.flickr.com/photos/boston_public_library/5786322835/</li>
        <li>http://www.flickr.com/photos/boston_public_library/5786875562/</li>
        <li>http://www.flickr.com/photos/boston_public_library/5786895180/</li>
    </ul>
  <li>ATOMIC Hot Links - http://www.flickr.com/photos/7552532@N07/2488898004/</li>
  <li>Mike Campbell - http://www.flickr.com/photos/morphyoss/4963981594/</li>
  <li>Swansea - http://www.freefoto.com/download/23-22-1/Swansea-London-Paddington-High-Speed-Train--HST-</li>
  <li>http://commons.wikimedia.org/wiki/File:Loket_vid_j%C3%A4rnv%C3%A4gsolyckan_i_Get%C3%A5_1918.jpg</li>
  <li>A.J. Russell - http://commons.wikimedia.org/wiki/File:A.J._Russell_(American_-_Railroad_Accident_Caused_by_Rebels_-_Google_Art_Project.jpg</li>
  <li>Bhanutpt - http://commons.wikimedia.org/wiki/File:Fast_Moving_Train_India.jpg</li>
  <li>Chris Updegrave - http://www.flickr.com/photos/cupdegrave/2253462031/</li>
  <li>SCFiasco - http://www.flickr.com/photos/scfiasco/4490322916/</li>
</ul>


</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,
				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: 'default', //Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'lib/js/fullscreen-img.js' }

					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});
      Reveal.addEventListener( 'fragmentshown', function( event ) {
        if (event.fragment.className.match(/(?:^|\s)subst(?!\S)/)) {
          event.fragment.previousElementSibling.className += " hidden";
        } 
      });
      Reveal.addEventListener( 'fragmenthidden', function( event ) {
        if (event.fragment.className.match(/(?:^|\s)subst(?!\S)/)) {
          event.fragment.previousElementSibling.className = 
            event.fragment.previousElementSibling.className.replace( /(?:^|\s)hidden(?!\S)/g , '' );
        }
      });
		</script>

	</body>
</html>
